name: Deploy Backend API

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'requirements.txt'
      - 'alembic/**'
      - 'deployment/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            echo "=== Backend API Deployment Started ==="

            PROJECT_PATH="/home/prompterly/public_html/api"
            SERVICE_NAME="prompterly-backend"

            # Backup .env if exists
            if [ -f "$PROJECT_PATH/.env" ]; then
              echo "Backing up .env file..."
              cp "$PROJECT_PATH/.env" /tmp/prompterly-env-backup
            fi

            # If not a git repo, remove and clone fresh
            if [ ! -d "$PROJECT_PATH/.git" ]; then
              echo "Not a git repo. Setting up fresh clone..."
              rm -rf "$PROJECT_PATH"
              mkdir -p "$PROJECT_PATH"
              git clone https://github.com/${{ github.repository }}.git "$PROJECT_PATH"
            fi

            cd "$PROJECT_PATH"

            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            git clean -fd

            # Restore .env if backed up
            if [ -f "/tmp/prompterly-env-backup" ]; then
              echo "Restoring .env file..."
              cp /tmp/prompterly-env-backup "$PROJECT_PATH/.env"
              rm /tmp/prompterly-env-backup
            fi

            # Create virtual environment if not exists
            if [ ! -d ".venv" ]; then
              echo "Creating virtual environment..."
              python3 -m venv .venv
            fi

            echo "Activating virtual environment..."
            source .venv/bin/activate

            echo "Installing dependencies..."
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "Running database migrations..."
            alembic upgrade head || echo "Migration skipped or failed"

            # Create uploads directory if not exists
            mkdir -p "$PROJECT_PATH/uploads"
            chmod 755 "$PROJECT_PATH/uploads"

            # Update systemd service
            echo "Updating systemd service..."
            sudo cp deployment/prompterly-backend.service /etc/systemd/system/${SERVICE_NAME}.service
            sudo systemctl daemon-reload
            sudo systemctl enable ${SERVICE_NAME}

            echo "Restarting backend service..."
            sudo systemctl restart ${SERVICE_NAME}

            # Wait a moment for service to start
            sleep 3

            echo "Checking service status..."
            sudo systemctl status ${SERVICE_NAME} --no-pager || true

            # Test health endpoint
            echo "Testing health endpoint..."
            curl -s http://127.0.0.1:8000/health || echo "Health check failed"

            echo "=== Backend API Deployment Completed ==="
